{% extends "layout.html" %}

{% block content %}
  <section class="grid grid-cols-1 xl:grid-cols-4 gap-4">
    <article class="mesh-card rounded-2xl p-5">
      <p class="text-xs text-slate-500">Nodes</p>
      <p class="text-3xl font-semibold">{{ nodes|length }}</p>
    </article>
    <article class="mesh-card rounded-2xl p-5">
      <p class="text-xs text-slate-500">SWIM Links</p>
      <p class="text-3xl font-semibold">{{ links|length }}</p>
    </article>
    <article class="mesh-card rounded-2xl p-5">
      <p class="text-xs text-slate-500">etcd Members</p>
      <p class="text-3xl font-semibold">{{ etcd.member_count }}</p>
      <p class="text-[11px] text-slate-500 mt-1">
        {{ etcd.healthy_endpoint_count }}/{{ etcd.endpoint_count }} healthy endpoints
      </p>
    </article>
    <article class="mesh-card rounded-2xl p-5">
      <p class="text-xs text-slate-500">Quorum</p>
      <p class="text-3xl font-semibold {% if etcd.has_quorum %}text-emerald-300{% else %}text-amber-200{% endif %}">
        {{ "OK" if etcd.has_quorum else "AT RISK" }}
      </p>
      <p class="text-[11px] text-slate-500 mt-1">required {{ etcd.quorum_required }}</p>
    </article>
  </section>

  {% if etcd.error %}
    <div class="mt-4 alert alert-warning mesh-card text-sm">
      <span class="mono">{{ etcd.error }}</span>
    </div>
  {% endif %}

  <section class="mesh-card rounded-2xl p-6 mt-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Network Map</h2>
      <p class="text-xs text-slate-500">Node color = total load (green 0 -> red 100)</p>
    </div>
    <div id="network-map" class="w-full rounded-2xl border border-slate-700/40 bg-slate-950/40 overflow-hidden"></div>
  </section>

  <section class="mesh-card rounded-2xl p-6 mt-6">
    <h2 class="text-lg font-semibold mb-4">Node Connectivity</h2>
    <div class="overflow-x-auto">
      <table class="table w-full">
        <thead>
          <tr>
            <th>Node ID</th>
            <th>Role</th>
            <th>SWIM State</th>
            <th>Total Load</th>
            <th>CPU/RAM/DISK/NET</th>
          </tr>
        </thead>
        <tbody>
          {% for node in nodes %}
            <tr>
              <td class="mono">{{ node.id }}</td>
              <td>{{ node.role_text }}</td>
              <td class="mono">{{ node.swim_state }}</td>
              <td class="mono">
                {% if node.load_total is not none %}
                  {{ "%.1f"|format(node.load_total) }}
                {% else %}
                  --
                {% endif %}
              </td>
              <td class="mono text-xs">
                {% if node.load_total is not none %}
                  {{ "%.1f"|format(node.load_cpu or 0) }} /
                  {{ "%.1f"|format(node.load_ram or 0) }} /
                  {{ "%.1f"|format(node.load_disk or 0) }} /
                  {{ "%.1f"|format(node.load_network or 0) }}
                {% else %}
                  --
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="5" class="text-slate-500">No nodes discovered.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <script>
    const nodes = {{ nodes | tojson }};
    const links = {{ links | tojson }};

    function nodeColor(loadTotal) {
      if (loadTotal === null || loadTotal === undefined || Number.isNaN(Number(loadTotal))) {
        return "hsl(220 10% 40%)";
      }
      const value = Math.max(0, Math.min(100, Number(loadTotal)));
      const hue = 120 - (value * 1.2);
      return `hsl(${hue} 82% 48%)`;
    }

    function drawMap() {
      const host = document.getElementById("network-map");
      const width = host.clientWidth || 1000;
      const height = 560;
      host.style.height = `${height}px`;
      host.innerHTML = "";

      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
      svg.setAttribute("width", "100%");
      svg.setAttribute("height", String(height));

      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.max(140, Math.min(width, height) * 0.33);
      const indexById = new Map();
      nodes.forEach((node, idx) => indexById.set(node.id, idx));

      const positioned = nodes.map((node, idx) => {
        const angle = (2 * Math.PI * idx) / Math.max(nodes.length, 1);
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;
        return { ...node, x, y };
      });

      const positionedById = new Map();
      positioned.forEach((node) => positionedById.set(node.id, node));

      links.forEach((link) => {
        const source = positionedById.get(link.source);
        const target = positionedById.get(link.target);
        if (!source || !target) return;
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", String(source.x));
        line.setAttribute("y1", String(source.y));
        line.setAttribute("x2", String(target.x));
        line.setAttribute("y2", String(target.y));
        line.setAttribute("stroke", "rgba(148,163,184,0.35)");
        line.setAttribute("stroke-width", "1.5");
        svg.appendChild(line);
      });

      positioned.forEach((node) => {
        const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
        group.setAttribute("transform", `translate(${node.x}, ${node.y})`);

        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("r", "34");
        circle.setAttribute("fill", nodeColor(node.load_total));
        circle.setAttribute("stroke", "rgba(255,255,255,0.65)");
        circle.setAttribute("stroke-width", "1.3");
        group.appendChild(circle);

        const idLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        idLabel.setAttribute("text-anchor", "middle");
        idLabel.setAttribute("y", "4");
        idLabel.setAttribute("fill", "#f8fafc");
        idLabel.setAttribute("font-size", "10");
        idLabel.setAttribute("font-family", "IBM Plex Mono, monospace");
        idLabel.textContent = node.id;
        group.appendChild(idLabel);

        const roleLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        roleLabel.setAttribute("text-anchor", "middle");
        roleLabel.setAttribute("y", "50");
        roleLabel.setAttribute("fill", "#cbd5e1");
        roleLabel.setAttribute("font-size", "11");
        roleLabel.textContent = node.role_text || "-";
        group.appendChild(roleLabel);

        const swimLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
        swimLabel.setAttribute("text-anchor", "middle");
        swimLabel.setAttribute("y", "63");
        swimLabel.setAttribute("fill", "#94a3b8");
        swimLabel.setAttribute("font-size", "10");
        swimLabel.textContent = `${node.swim_state}`;
        group.appendChild(swimLabel);

        const title = document.createElementNS("http://www.w3.org/2000/svg", "title");
        title.textContent =
          `${node.id}\nrole: ${node.role_text}\nstate: ${node.swim_state}\n` +
          `total: ${node.load_total ?? "--"}\n` +
          `cpu: ${node.load_cpu ?? "--"} ram: ${node.load_ram ?? "--"} disk: ${node.load_disk ?? "--"} net: ${node.load_network ?? "--"}`;
        group.appendChild(title);

        svg.appendChild(group);
      });

      host.appendChild(svg);
    }

    drawMap();
    window.addEventListener("resize", drawMap);
  </script>
{% endblock %}
