{% extends "layout.html" %}

{% block content %}
  <section class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Total Nodes</p>
      <p class="text-2xl font-semibold">{{ node_total }}</p>
    </div>
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Online</p>
      <p class="text-2xl font-semibold text-emerald-300">{{ node_online }}</p>
    </div>
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Stale / Offline</p>
      <p class="text-2xl font-semibold text-amber-200">{{ node_stale }} / {{ node_offline }}</p>
    </div>
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Failover Active</p>
      <p class="text-2xl font-semibold">{{ node_failover }}</p>
    </div>
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Cert Risk</p>
      <p class="text-2xl font-semibold text-amber-200">{{ cert_warning + cert_critical + cert_expired }}</p>
      <p class="text-[11px] text-slate-500 mt-1">
        warn {{ cert_warning }} · critical {{ cert_critical }} · expired {{ cert_expired }}
      </p>
    </div>
  </section>

  {% if etcd.error %}
    <div class="mb-6 alert alert-warning mesh-card text-sm">
      <span class="mono">{{ etcd.error }}</span>
    </div>
  {% endif %}

  <div class="flex flex-wrap gap-3 mb-6">
    <a class="btn btn-sm {% if view_mode == 'table' %}btn-primary{% else %}btn-outline{% endif %}" href="{{ ui_prefix }}/nodes?view=table">Table View</a>
    <a class="btn btn-sm {% if view_mode == 'map' %}btn-primary{% else %}btn-outline{% endif %}" href="{{ ui_prefix }}/nodes?view=map">Topology View</a>
    <span class="badge badge-outline mono py-3">etcd members {{ etcd.member_count }}</span>
    <span class="badge badge-outline mono py-3">
      quorum {{ "ok" if etcd.has_quorum else "at-risk" }} ({{ etcd.healthy_endpoint_count }}/{{ etcd.endpoint_count }})
    </span>
  </div>

  {% if view_mode == "map" %}
    <section class="mesh-card rounded-2xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Network Map</h2>
        <p class="text-xs text-slate-500">Node color = total load (green 0 -> red 100)</p>
      </div>
      <div id="network-map" class="w-full rounded-2xl border border-slate-700/40 bg-slate-950/40 overflow-hidden"></div>
    </section>

    <section class="mesh-card rounded-2xl p-6">
      <h2 class="text-lg font-semibold mb-4">Node Connectivity</h2>
      <div class="overflow-x-auto">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Node ID</th>
              <th>Role</th>
              <th>SWIM State</th>
              <th>Total Load</th>
              <th>CPU/RAM/DISK/NET</th>
            </tr>
          </thead>
          <tbody>
            {% for node in map_nodes %}
              <tr>
                <td class="mono">{{ node.id }}</td>
                <td>{{ node.role_text }}</td>
                <td class="mono">{{ node.swim_state }}</td>
                <td class="mono">
                  {% if node.load_total is not none %}
                    {{ "%.1f"|format(node.load_total) }}
                  {% else %}
                    --
                  {% endif %}
                </td>
                <td class="mono text-xs">
                  {% if node.load_total is not none %}
                    {{ "%.1f"|format(node.load_cpu or 0) }} /
                    {{ "%.1f"|format(node.load_ram or 0) }} /
                    {{ "%.1f"|format(node.load_disk or 0) }} /
                    {{ "%.1f"|format(node.load_network or 0) }}
                  {% else %}
                    --
                  {% endif %}
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="5" class="text-slate-500">No nodes discovered.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  {% else %}
    <section class="mesh-card rounded-2xl p-6 mb-6">
      <h2 class="text-lg font-semibold">Node Inventory</h2>
      <div class="overflow-x-auto mt-5">
        <table class="table w-full align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Mesh IP</th>
              <th>Endpoint</th>
              <th>Roles</th>
              <th>Load</th>
              <th>SWIM</th>
              <th>WireGuard</th>
              <th>Cert</th>
              <th>Lease</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for node in nodes %}
              <tr class="hover">
                <td>
                  <a class="font-semibold hover:underline" href="{{ ui_prefix }}/nodes/{{ node.id }}">{{ node.name }}</a>
                  <p class="mono text-[11px] text-slate-500 mt-1">{{ node.id }}</p>
                </td>
                <td>
                  {% if node.health_tone == "success" %}
                    <span class="badge badge-success badge-outline">{{ node.health_text }}</span>
                  {% elif node.health_tone == "warning" %}
                    <span class="badge badge-warning badge-outline">{{ node.health_text }}</span>
                  {% else %}
                    <span class="badge badge-error badge-outline">{{ node.health_text }}</span>
                  {% endif %}
                  <p class="mono text-[11px] text-slate-500 mt-1">hb {{ node.heartbeat_age }}</p>
                </td>
                <td class="mono text-xs">{{ node.mesh_ip }}</td>
                <td class="mono text-xs">{{ node.endpoint }}</td>
                <td>{{ node.roles_text }}</td>
                <td>
                  {% if node.load_total is not none %}
                    <p class="mono text-xs">total {{ "%.1f"|format(node.load_total) }}</p>
                    <p class="text-[11px] text-slate-500 mt-1">
                      c {{ "%.1f"|format(node.load_cpu or 0) }} · r {{ "%.1f"|format(node.load_ram or 0) }} ·
                      d {{ "%.1f"|format(node.load_disk or 0) }} · n {{ "%.1f"|format(node.load_network or 0) }}
                    </p>
                  {% else %}
                    <span class="text-slate-500 text-xs">No load report</span>
                  {% endif %}
                </td>
                <td>
                  <p class="mono text-xs">{{ node.swim_state }}</p>
                  <p class="text-[11px] text-slate-500 mt-1">inc {{ node.swim_incarnation }}</p>
                </td>
                <td>
                  <p class="mono text-xs">{{ node.wg_active_route }}</p>
                  <p class="text-[11px] text-slate-500 mt-1">{{ node.wg_failover }}</p>
                </td>
                <td>
                  {% if node.identity_expiry_state == "ok" %}
                    <span class="badge badge-success badge-outline">{{ node.identity_expiry_text }}</span>
                  {% elif node.identity_expiry_state == "warning" %}
                    <span class="badge badge-warning badge-outline">{{ node.identity_expiry_text }}</span>
                  {% elif node.identity_expiry_state in ["critical", "expired"] %}
                    <span class="badge badge-error badge-outline">{{ node.identity_expiry_text }}</span>
                  {% else %}
                    <span class="badge badge-outline">{{ node.identity_expiry_text }}</span>
                  {% endif %}
                  <p class="mono text-[11px] text-slate-500 mt-1">{{ node.identity_expires_in }}</p>
                </td>
                <td class="text-sm">
                  <p>{{ node.lease_state }}</p>
                  <p class="mono text-[11px] text-slate-500 mt-1">{{ node.lease_expires_at }}</p>
                </td>
                <td>
                  <div class="flex flex-wrap gap-2">
                    <a class="btn btn-xs btn-outline" href="{{ ui_prefix }}/nodes/{{ node.id }}">View</a>
                    <button class="btn btn-xs btn-outline" onclick="nodeAction('{{ node.id }}', 'cordon')">Cordon</button>
                    <button class="btn btn-xs btn-outline" onclick="nodeAction('{{ node.id }}', 'drain')">Drain</button>
                    <button class="btn btn-xs btn-outline" onclick="nodeAction('{{ node.id }}', 'rotate-wg-keys')">Rotate Keys</button>
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="11" class="text-center text-slate-400">No nodes registered yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  {% endif %}

  <section class="mesh-card rounded-2xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Role Placement</h2>
      <a class="btn btn-xs btn-outline" href="{{ ui_prefix }}/roles">Detailed Role View</a>
    </div>
    <div class="overflow-x-auto">
      <table class="table w-full">
        <thead>
          <tr>
            <th>Role</th>
            <th>Desired</th>
            <th>Assigned</th>
            <th>Deficit</th>
            <th>Holders</th>
          </tr>
        </thead>
        <tbody>
          {% for role in role_rows %}
            <tr>
              <td class="mono">{{ role.name }}</td>
              <td class="mono">{{ role.desired }}</td>
              <td class="mono">{{ role.assigned }}</td>
              <td class="mono">{{ role.deficit }}</td>
              <td class="mono text-xs">
                {% if role.holders %}
                  {{ role.holders | join(", ") }}
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="5" class="text-slate-500">No role definitions found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <script>
    async function nodeAction(nodeId, action) {
      try {
        const response = await fetch(`/nodes/${nodeId}/${action}`, { method: "POST" });
        if (response.ok) {
          window.location.reload();
          return;
        }
        const body = await response.text();
        alert(`Action failed (${response.status}): ${body}`);
      } catch (error) {
        alert(`Action failed: ${error}`);
      }
    }

    {% if view_mode == "map" %}
      const nodes = {{ map_nodes | tojson }};
      const links = {{ map_links | tojson }};

      function nodeColor(loadTotal) {
        if (loadTotal === null || loadTotal === undefined || Number.isNaN(Number(loadTotal))) {
          return "hsl(220 10% 40%)";
        }
        const value = Math.max(0, Math.min(100, Number(loadTotal)));
        const hue = 120 - (value * 1.2);
        return `hsl(${hue} 82% 48%)`;
      }

      function drawMap() {
        const host = document.getElementById("network-map");
        if (!host) return;
        const width = host.clientWidth || 1000;
        const height = 560;
        host.style.height = `${height}px`;
        host.innerHTML = "";

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", String(height));

        const centerX = width / 2;
        const centerY = height / 2;
        const radius = Math.max(140, Math.min(width, height) * 0.33);
        const positioned = nodes.map((node, idx) => {
          const angle = (2 * Math.PI * idx) / Math.max(nodes.length, 1);
          const x = centerX + Math.cos(angle) * radius;
          const y = centerY + Math.sin(angle) * radius;
          return { ...node, x, y };
        });
        const positionedById = new Map();
        positioned.forEach((node) => positionedById.set(node.id, node));

        links.forEach((link) => {
          const source = positionedById.get(link.source);
          const target = positionedById.get(link.target);
          if (!source || !target) return;
          const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
          line.setAttribute("x1", String(source.x));
          line.setAttribute("y1", String(source.y));
          line.setAttribute("x2", String(target.x));
          line.setAttribute("y2", String(target.y));
          line.setAttribute("stroke", "rgba(148,163,184,0.35)");
          line.setAttribute("stroke-width", "1.5");
          svg.appendChild(line);
        });

        positioned.forEach((node) => {
          const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
          group.setAttribute("transform", `translate(${node.x}, ${node.y})`);

          const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute("r", "34");
          circle.setAttribute("fill", nodeColor(node.load_total));
          circle.setAttribute("stroke", "rgba(255,255,255,0.65)");
          circle.setAttribute("stroke-width", "1.3");
          group.appendChild(circle);

          const idLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          idLabel.setAttribute("text-anchor", "middle");
          idLabel.setAttribute("y", "4");
          idLabel.setAttribute("fill", "#f8fafc");
          idLabel.setAttribute("font-size", "10");
          idLabel.setAttribute("font-family", "IBM Plex Mono, monospace");
          idLabel.textContent = node.id;
          group.appendChild(idLabel);

          const roleLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          roleLabel.setAttribute("text-anchor", "middle");
          roleLabel.setAttribute("y", "50");
          roleLabel.setAttribute("fill", "#cbd5e1");
          roleLabel.setAttribute("font-size", "11");
          roleLabel.textContent = node.role_text || "-";
          group.appendChild(roleLabel);

          const swimLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
          swimLabel.setAttribute("text-anchor", "middle");
          swimLabel.setAttribute("y", "63");
          swimLabel.setAttribute("fill", "#94a3b8");
          swimLabel.setAttribute("font-size", "10");
          swimLabel.textContent = `${node.swim_state}`;
          group.appendChild(swimLabel);

          const title = document.createElementNS("http://www.w3.org/2000/svg", "title");
          title.textContent =
            `${node.id}\nrole: ${node.role_text}\nstate: ${node.swim_state}\n` +
            `total: ${node.load_total ?? "--"}\n` +
            `cpu: ${node.load_cpu ?? "--"} ram: ${node.load_ram ?? "--"} disk: ${node.load_disk ?? "--"} net: ${node.load_network ?? "--"}`;
          group.appendChild(title);

          svg.appendChild(group);
        });

        host.appendChild(svg);
      }

      drawMap();
      window.addEventListener("resize", drawMap);
    {% endif %}
  </script>
{% endblock %}
