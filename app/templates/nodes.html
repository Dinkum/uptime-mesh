{% extends "layout.html" %}

{% block content %}
  <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Total Nodes</p>
      <p class="text-2xl font-semibold">{{ node_total }}</p>
    </div>
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Online</p>
      <p class="text-2xl font-semibold text-emerald-300">{{ node_online }}</p>
    </div>
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Stale / Offline</p>
      <p class="text-2xl font-semibold text-amber-200">{{ node_stale }} / {{ node_offline }}</p>
    </div>
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Failover Active</p>
      <p class="text-2xl font-semibold">{{ node_failover }}</p>
    </div>
  </section>

  <div class="mesh-card rounded-2xl p-6">
    <h2 class="text-lg font-semibold">Node Inventory</h2>
    <div class="overflow-x-auto mt-5">
      <table class="table w-full align-middle">
        <thead>
          <tr>
            <th>Name</th>
            <th>Status</th>
            <th>Mesh IP</th>
            <th>Endpoint</th>
            <th>Roles</th>
            <th>Load</th>
            <th>SWIM</th>
            <th>WireGuard</th>
            <th>Lease</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for node in nodes %}
            <tr class="hover">
              <td>
                <a class="font-semibold hover:underline" href="{{ ui_prefix }}/nodes/{{ node.id }}">{{ node.name }}</a>
                <p class="mono text-[11px] text-slate-500 mt-1">{{ node.id }}</p>
              </td>
              <td>
                {% if node.health_tone == "success" %}
                  <span class="badge badge-success badge-outline">{{ node.health_text }}</span>
                {% elif node.health_tone == "warning" %}
                  <span class="badge badge-warning badge-outline">{{ node.health_text }}</span>
                {% else %}
                  <span class="badge badge-error badge-outline">{{ node.health_text }}</span>
                {% endif %}
                <p class="mono text-[11px] text-slate-500 mt-1">hb {{ node.heartbeat_age }}</p>
              </td>
              <td class="mono text-xs">{{ node.mesh_ip }}</td>
              <td class="mono text-xs">{{ node.endpoint }}</td>
              <td>{{ node.roles_text }}</td>
              <td>
                {% if node.load_total is not none %}
                  <p class="mono text-xs">total {{ "%.1f"|format(node.load_total) }}</p>
                  <p class="text-[11px] text-slate-500 mt-1">
                    c {{ "%.1f"|format(node.load_cpu or 0) }} · r {{ "%.1f"|format(node.load_ram or 0) }} ·
                    d {{ "%.1f"|format(node.load_disk or 0) }} · n {{ "%.1f"|format(node.load_network or 0) }}
                  </p>
                {% else %}
                  <span class="text-slate-500 text-xs">No load report</span>
                {% endif %}
              </td>
              <td>
                <p class="mono text-xs">{{ node.swim_state }}</p>
                <p class="text-[11px] text-slate-500 mt-1">inc {{ node.swim_incarnation }}</p>
              </td>
              <td>
                <p class="mono text-xs">{{ node.wg_active_route }}</p>
                <p class="text-[11px] text-slate-500 mt-1">{{ node.wg_failover }}</p>
              </td>
              <td class="text-sm">
                <p>{{ node.lease_state }}</p>
                <p class="mono text-[11px] text-slate-500 mt-1">{{ node.lease_expires_at }}</p>
              </td>
              <td>
                <div class="flex flex-wrap gap-2">
                  <a class="btn btn-xs btn-outline" href="{{ ui_prefix }}/nodes/{{ node.id }}">View</a>
                  <button class="btn btn-xs btn-outline" onclick="nodeAction('{{ node.id }}', 'cordon')">Cordon</button>
                  <button class="btn btn-xs btn-outline" onclick="nodeAction('{{ node.id }}', 'drain')">Drain</button>
                  <button class="btn btn-xs btn-outline" onclick="nodeAction('{{ node.id }}', 'rotate-wg-keys')">Rotate Keys</button>
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="10" class="text-center text-slate-400">No nodes registered yet.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    async function nodeAction(nodeId, action) {
      try {
        const response = await fetch(`/nodes/${nodeId}/${action}`, { method: "POST" });
        if (response.ok) {
          window.location.reload();
          return;
        }
        const body = await response.text();
        alert(`Action failed (${response.status}): ${body}`);
      } catch (error) {
        alert(`Action failed: ${error}`);
      }
    }
  </script>
{% endblock %}
