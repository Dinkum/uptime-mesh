{% extends "layout.html" %}

{% block content %}
  <style>
    .settings-card {
      border: 1px solid rgba(148, 163, 184, 0.24);
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.82));
      box-shadow: 0 22px 48px rgba(2, 6, 23, 0.55);
      backdrop-filter: blur(7px);
    }
    .settings-label {
      display: block;
      margin-bottom: 0.35rem;
      font-size: 0.84rem;
      color: #cbd5e1;
      font-weight: 600;
    }
    .settings-input {
      width: 100%;
      min-width: 0;
      border-radius: 0.75rem;
      border: 1px solid rgba(100, 116, 139, 0.75);
      background: rgba(2, 6, 23, 0.75);
      color: #f8fafc;
      padding: 0.72rem 0.9rem;
      line-height: 1.35;
    }
    .settings-input::placeholder {
      color: #94a3b8;
    }
    .settings-input:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.95);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
    }
    .settings-help {
      color: #94a3b8;
      font-size: 0.8rem;
      margin-top: 0.35rem;
    }
  </style>

  <section class="mesh-subtabs-shell mb-6" aria-label="Settings sections">
    <p class="mesh-subtabs-label">Settings Sections</p>
    <nav class="mesh-subtabs">
      <a class="mesh-subtab{% if settings_section == 'auth' %} active{% endif %}" href="{{ ui_prefix }}/settings?section=auth">Auth & Preferences</a>
      <a class="mesh-subtab{% if settings_section == 'routing' %} active{% endif %}" href="{{ ui_prefix }}/settings?section=routing">Routing & Domains</a>
      <a class="mesh-subtab{% if settings_section == 'providers' %} active{% endif %}" href="{{ ui_prefix }}/settings?section=providers">Providers</a>
      <a class="mesh-subtab{% if settings_section == 'support' %} active{% endif %}" href="{{ ui_prefix }}/settings?section=support">Support & Snapshots</a>
    </nav>
  </section>

  {% if settings_section == "support" %}
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <article class="settings-card rounded-2xl p-6">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">etcd Snapshots</h2>
            <p class="text-sm text-slate-500">Run snapshots now and track restore readiness.</p>
          </div>
          <button class="btn btn-sm btn-outline" id="snapshot-btn">Request Snapshot</button>
        </div>
        <div class="mt-4 space-y-2 text-sm" id="snapshot-list">
          {% for snapshot in snapshots %}
            <div class="rounded-xl border border-slate-700/40 p-3">
              <div class="flex justify-between items-center gap-3">
                <div class="flex flex-col min-w-0">
                  <span class="mono truncate">{{ snapshot.id }}</span>
                  {% if snapshot.location %}
                    <span class="text-xs text-slate-500 truncate">{{ snapshot.location }}</span>
                  {% endif %}
                </div>
                <div class="flex items-center gap-2 shrink-0">
                  <span class="badge badge-outline">{{ snapshot.status }}</span>
                  {% if snapshot.status == "completed" %}
                    <button class="btn btn-xs btn-outline snapshot-restore-btn" data-snapshot-id="{{ snapshot.id }}">Restore</button>
                    {% if snapshot.location %}
                      <a class="btn btn-xs btn-outline" href="/etcd/snapshots/{{ snapshot.id }}/download">Download</a>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
              {% if snapshot.error %}
                <p class="text-xs text-rose-300 break-all mt-2">{{ snapshot.error }}</p>
              {% endif %}
            </div>
          {% else %}
            <p class="text-slate-400">No snapshots yet.</p>
          {% endfor %}
        </div>
      </article>

      <article class="settings-card rounded-2xl p-6">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">Support Bundles</h2>
            <p class="text-sm text-slate-500">Collect redacted diagnostics for troubleshooting.</p>
          </div>
          <button class="btn btn-sm btn-outline" id="bundle-btn">Request Bundle</button>
        </div>
        <div class="mt-4 space-y-2 text-sm" id="bundle-list">
          {% for bundle in bundles %}
            <div class="rounded-xl border border-slate-700/40 p-3">
              <div class="flex justify-between items-center gap-3">
                <span class="mono truncate">{{ bundle.id }}</span>
                <div class="flex items-center gap-2 shrink-0">
                  <span class="badge badge-outline">{{ bundle.status }}</span>
                  {% if bundle.status == "completed" and bundle.path %}
                    <a class="btn btn-xs btn-outline" href="/support-bundles/{{ bundle.id }}/download">Download</a>
                  {% endif %}
                </div>
              </div>
              {% if bundle.error %}
                <p class="text-xs text-rose-300 break-all mt-2">{{ bundle.error }}</p>
              {% endif %}
            </div>
          {% else %}
            <p class="text-slate-400">No bundles yet.</p>
          {% endfor %}
        </div>
      </article>
    </section>

    <script>
      const snapshotBtn = document.getElementById("snapshot-btn");
      const bundleBtn = document.getElementById("bundle-btn");

      function addRow(containerId, id, status, extras) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const row = document.createElement("div");
        row.className = "rounded-xl border border-slate-700/40 p-3";

        if (containerId === "snapshot-list") {
          const restoreButton = status === "completed"
            ? `<button class="btn btn-xs btn-outline snapshot-restore-btn" data-snapshot-id="${id}">Restore</button>`
            : "";
          const download = extras && extras.download
            ? `<a class="btn btn-xs btn-outline" href="${extras.download}">Download</a>`
            : "";
          const error = extras && extras.error
            ? `<p class="text-xs text-rose-300 break-all mt-2">${extras.error}</p>`
            : "";
          row.innerHTML = `
            <div class="flex justify-between items-center gap-3">
              <div class="flex flex-col min-w-0">
                <span class="mono truncate">${id}</span>
              </div>
              <div class="flex items-center gap-2 shrink-0">
                <span class="badge badge-outline">${status}</span>
                ${restoreButton}
                ${download}
              </div>
            </div>
            ${error}
          `;
        } else {
          const download = extras && extras.download
            ? `<a class="btn btn-xs btn-outline" href="${extras.download}">Download</a>`
            : "";
          const error = extras && extras.error
            ? `<p class="text-xs text-rose-300 break-all mt-2">${extras.error}</p>`
            : "";
          row.innerHTML = `
            <div class="flex justify-between items-center gap-3">
              <span class="mono truncate">${id}</span>
              <div class="flex items-center gap-2 shrink-0">
                <span class="badge badge-outline">${status}</span>
                ${download}
              </div>
            </div>
            ${error}
          `;
        }

        container.prepend(row);
      }

      async function restoreSnapshot(snapshotId) {
        const response = await fetch(`/etcd/snapshots/${snapshotId}/restore`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        if (response.ok) {
          const data = await response.json();
          const download = data.location ? `/etcd/snapshots/${data.id}/download` : "";
          addRow("snapshot-list", data.id, data.status, { download, error: data.error || "" });
        }
      }

      if (snapshotBtn) {
        snapshotBtn.addEventListener("click", async () => {
          const id = crypto.randomUUID();
          const response = await fetch("/etcd/snapshots", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id })
          });
          if (response.ok) {
            const data = await response.json();
            const download = data.location ? `/etcd/snapshots/${data.id}/download` : "";
            addRow("snapshot-list", data.id, data.status, { download, error: data.error || "" });
          }
        });
      }

      if (bundleBtn) {
        bundleBtn.addEventListener("click", async () => {
          const id = crypto.randomUUID();
          const response = await fetch("/support-bundles", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id })
          });
          if (response.ok) {
            const data = await response.json();
            const download = data.path ? `/support-bundles/${data.id}/download` : "";
            addRow("bundle-list", data.id, data.status, { download, error: data.error || "" });
          }
        });
      }

      document.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        if (!target.classList.contains("snapshot-restore-btn")) {
          return;
        }
        const snapshotId = target.getAttribute("data-snapshot-id");
        if (!snapshotId) {
          return;
        }
        await restoreSnapshot(snapshotId);
      });
    </script>

  {% elif settings_section == "routing" %}
    <section class="grid gap-6 lg:grid-cols-2">
      <article class="settings-card rounded-2xl p-6 lg:col-span-2">
        <h2 class="text-lg font-semibold">Applications</h2>
        <p class="text-sm text-slate-500">Map external domains to internal application/service targets. `hello-world` is pre-seeded.</p>

        {% if routing_success %}
          <div class="alert alert-success text-sm mt-3">
            <span>{{ routing_success }}</span>
          </div>
        {% endif %}
        {% if routing_error %}
          <div class="alert alert-error text-sm mt-3">
            <span>{{ routing_error }}</span>
          </div>
        {% endif %}

        <div class="overflow-x-auto mt-4">
          <table class="table w-full">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Target Service</th>
                <th>Default Path</th>
                <th>Enabled</th>
              </tr>
            </thead>
            <tbody>
              {% for app in applications %}
                <tr>
                  <td class="mono text-xs">{{ app.id }}</td>
                  <td>{{ app.name }}</td>
                  <td class="mono text-xs">{{ app.target_service_id or "-" }}</td>
                  <td class="mono text-xs">{{ app.default_path }}</td>
                  <td>
                    {% if app.enabled %}
                      <span class="badge badge-success badge-outline">on</span>
                    {% else %}
                      <span class="badge badge-outline">off</span>
                    {% endif %}
                  </td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="5" class="text-slate-500">No applications configured.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <form method="post" action="{{ ui_prefix }}/settings/routing/application" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-5">
          <label class="block">
            <span class="settings-label">Application ID</span>
            <input class="settings-input mono" type="text" name="app_id" placeholder="hello-world" />
            <p class="settings-help">Use existing ID to update, or leave blank to derive from the name.</p>
          </label>
          <label class="block">
            <span class="settings-label">Name</span>
            <input class="settings-input" type="text" name="name" placeholder="Hello World" />
          </label>
          <label class="block md:col-span-2">
            <span class="settings-label">Description</span>
            <input class="settings-input" type="text" name="description" placeholder="Public app description" />
          </label>
          <label class="block">
            <span class="settings-label">Target Service</span>
            <select class="settings-input mono" name="target_service_id">
              <option value="">(none)</option>
              {% for service in service_options %}
                <option value="{{ service.id }}">{{ service.name }} ({{ service.id }})</option>
              {% endfor %}
            </select>
          </label>
          <label class="block">
            <span class="settings-label">Default Path</span>
            <input class="settings-input mono" type="text" name="default_path" value="/" />
          </label>
          <label class="inline-flex items-center gap-2 mt-1 md:col-span-2">
            <input type="checkbox" name="enabled" value="true" checked />
            <span class="text-sm text-slate-300">Application enabled</span>
          </label>
          <div class="md:col-span-2">
            <button class="btn btn-primary" type="submit">Save Application</button>
          </div>
        </form>
      </article>

      <article class="settings-card rounded-2xl p-6 lg:col-span-2">
        <h2 class="text-lg font-semibold">Domain Routes</h2>
        <p class="text-sm text-slate-500">Bind domains/subdomains to applications. Gateway will route matching host + path to the selected app target service.</p>

        <div class="overflow-x-auto mt-4">
          <table class="table w-full">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Path</th>
                <th>Application</th>
                <th>Route</th>
                <th>Ready</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for binding in domain_bindings %}
                <tr>
                  <td class="mono text-xs">{{ binding.domain }}</td>
                  <td class="mono text-xs">{{ binding.path }}</td>
                  <td>{{ binding.application_name }} <span class="text-xs text-slate-500 mono">({{ binding.application_id }})</span></td>
                  <td>
                    {% if binding.route_enabled %}
                      <span class="badge badge-success badge-outline">enabled</span>
                    {% else %}
                      <span class="badge badge-outline">disabled</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if binding.routing_ready %}
                      <span class="badge badge-success badge-outline">ready</span>
                    {% else %}
                      <span class="badge badge-warning badge-outline">blocked</span>
                    {% endif %}
                  </td>
                  <td>
                    <form method="post" action="{{ ui_prefix }}/settings/routing/domain/delete">
                      <input type="hidden" name="route_id" value="{{ binding.id }}" />
                      <button class="btn btn-xs btn-outline" type="submit">Delete</button>
                    </form>
                  </td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="6" class="text-slate-500">No domain routes configured.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <form method="post" action="{{ ui_prefix }}/settings/routing/domain" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-5">
          <label class="block">
            <span class="settings-label">Route ID</span>
            <input class="settings-input mono" type="text" name="route_id" placeholder="optional-id" />
            <p class="settings-help">Use existing ID to update. Leave blank to auto-generate.</p>
          </label>
          <label class="block">
            <span class="settings-label">Domain</span>
            <input class="settings-input mono" type="text" name="domain" placeholder="app.example.com" required />
          </label>
          <label class="block">
            <span class="settings-label">Path Prefix</span>
            <input class="settings-input mono" type="text" name="path" value="/" />
          </label>
          <label class="block">
            <span class="settings-label">Application</span>
            <select class="settings-input mono" name="application_id" required>
              <option value="">Select application</option>
              {% for app in applications %}
                <option value="{{ app.id }}">{{ app.name }} ({{ app.id }})</option>
              {% endfor %}
            </select>
          </label>
          <label class="inline-flex items-center gap-2 mt-1 md:col-span-2">
            <input type="checkbox" name="enabled" value="true" checked />
            <span class="text-sm text-slate-300">Route enabled</span>
          </label>
          <div class="md:col-span-2">
            <button class="btn btn-primary" type="submit">Save Domain Route</button>
          </div>
        </form>
      </article>

      <article class="settings-card rounded-2xl p-6 lg:col-span-2">
        <h2 class="text-lg font-semibold">External DNS Records</h2>
        <p class="text-sm text-slate-500">If UptimeMesh is not managing DNS in your provider account, create these records manually.</p>
        {% if not domain_ingress_target %}
          <div class="alert alert-warning text-sm mt-3">
            <span>Set <span class="mono">Domain Ingress Target</span> under the Providers section to generate concrete DNS records.</span>
          </div>
        {% else %}
          <p class="text-xs text-slate-400 mt-3">Ingress target: <span class="mono">{{ domain_ingress_target }}</span></p>
        {% endif %}
        <div class="overflow-x-auto mt-4">
          <table class="table w-full">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Type</th>
                <th>Value</th>
                <th>Instructions</th>
              </tr>
            </thead>
            <tbody>
              {% for row in dns_record_rows %}
                <tr>
                  <td class="mono text-xs">{{ row.domain }}</td>
                  <td class="mono text-xs">{{ row.record_type }}</td>
                  <td class="mono text-xs">{{ row.record_value }}</td>
                  <td class="text-xs">{{ row.instructions or "Set a domain ingress target to generate instructions." }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="4" class="text-slate-500">No domain routes found.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </article>
    </section>

  {% elif settings_section == "providers" %}
    <section class="grid gap-6 lg:grid-cols-2">
      <article class="settings-card rounded-2xl p-6 lg:col-span-2">
        <h2 class="text-lg font-semibold">Provider Credentials</h2>
        <p class="text-sm text-slate-500">Configure external API providers for DNS automation, VPS provisioning, and Codex/OpenAI-assisted operations.</p>

        {% if provider_success %}
          <div class="alert alert-success text-sm mt-3">
            <span>{{ provider_success }}</span>
          </div>
        {% endif %}

        {% if provider_error %}
          <div class="alert alert-error text-sm mt-3">
            <span>{{ provider_error }}</span>
          </div>
        {% endif %}

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4 text-sm">
          <div class="rounded-xl border border-slate-700/40 p-3">
            <p class="text-slate-500">OpenAI API Key</p>
            <p class="mono mt-1">{{ "configured" if provider_configured.provider_openai_api_key else "not set" }}</p>
          </div>
          <div class="rounded-xl border border-slate-700/40 p-3">
            <p class="text-slate-500">Cloudflare Token</p>
            <p class="mono mt-1">{{ "configured" if provider_configured.provider_cloudflare_api_token else "not set" }}</p>
          </div>
          <div class="rounded-xl border border-slate-700/40 p-3">
            <p class="text-slate-500">Hetzner Token</p>
            <p class="mono mt-1">{{ "configured" if provider_configured.provider_hetzner_api_token else "not set" }}</p>
          </div>
          <div class="rounded-xl border border-slate-700/40 p-3">
            <p class="text-slate-500">Scaleway Token</p>
            <p class="mono mt-1">{{ "configured" if provider_configured.provider_scaleway_api_token else "not set" }}</p>
          </div>
          <div class="rounded-xl border border-slate-700/40 p-3">
            <p class="text-slate-500">Online.net Token</p>
            <p class="mono mt-1">{{ "configured" if provider_configured.provider_online_api_token else "not set" }}</p>
          </div>
          <div class="rounded-xl border border-slate-700/40 p-3">
            <p class="text-slate-500">Cloudflare Zone ID</p>
            <p class="mono mt-1">{{ provider_cloudflare_zone_id or "not set" }}</p>
          </div>
        </div>

        <form method="post" action="{{ ui_prefix }}/settings/providers" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-5">
          <label class="block md:col-span-2">
            <span class="settings-label">Domain Ingress Target</span>
            <input class="settings-input mono" type="text" name="domain_ingress_target" value="{{ domain_ingress_target }}" placeholder="203.0.113.10 or ingress.example.net" />
            <p class="settings-help">Used to generate DNS records for manual provider setup.</p>
          </label>

          <label class="block">
            <span class="settings-label">OpenAI API Key</span>
            <input class="settings-input" type="password" name="provider_openai_api_key" placeholder="Leave blank to keep existing" />
          </label>
          <label class="block">
            <span class="settings-label">Cloudflare API Token</span>
            <input class="settings-input" type="password" name="provider_cloudflare_api_token" placeholder="Leave blank to keep existing" />
          </label>
          <label class="block">
            <span class="settings-label">Cloudflare Zone ID</span>
            <input class="settings-input mono" type="text" name="provider_cloudflare_zone_id" value="{{ provider_cloudflare_zone_id }}" placeholder="Cloudflare zone id" />
          </label>
          <label class="block">
            <span class="settings-label">Hetzner API Token</span>
            <input class="settings-input" type="password" name="provider_hetzner_api_token" placeholder="Leave blank to keep existing" />
          </label>
          <label class="block">
            <span class="settings-label">Scaleway API Token</span>
            <input class="settings-input" type="password" name="provider_scaleway_api_token" placeholder="Leave blank to keep existing" />
          </label>
          <label class="block">
            <span class="settings-label">Online.net API Token</span>
            <input class="settings-input" type="password" name="provider_online_api_token" placeholder="Leave blank to keep existing" />
          </label>
          <div class="md:col-span-2">
            <button class="btn btn-primary" type="submit">Save Provider Settings</button>
          </div>
        </form>
      </article>
    </section>

  {% else %}
    <section class="grid gap-6 lg:grid-cols-2">
      <article class="settings-card rounded-2xl p-6">
        <h2 class="text-lg font-semibold">Authentication</h2>
        <p class="text-sm text-slate-500">Rotate the admin password used for UI access.</p>
        <div class="mt-3">
          <span class="text-xs uppercase tracking-widest text-slate-500">Current Username</span>
          <p class="mono text-sm mt-1">{{ username }}</p>
        </div>
      </article>

      <article class="settings-card rounded-2xl p-6">
        <h2 class="text-lg font-semibold">Change Password</h2>

        {% if password_success %}
          <div class="alert alert-success text-sm mt-3">
            <span>{{ password_success }}</span>
          </div>
        {% endif %}

        {% if password_error %}
          <div class="alert alert-error text-sm mt-3">
            <span>{{ password_error }}</span>
          </div>
        {% endif %}

        <form method="post" action="{{ ui_prefix }}/settings/password" class="space-y-3 mt-4">
          <label class="block">
            <span class="settings-label">Current Password</span>
            <input class="settings-input" type="password" name="current_password" required autocomplete="current-password" />
          </label>

          <label class="block">
            <span class="settings-label">New Password</span>
            <input class="settings-input" type="password" name="new_password" minlength="8" required autocomplete="new-password" />
            <p class="settings-help">Minimum 8 characters.</p>
          </label>

          <label class="block">
            <span class="settings-label">Confirm New Password</span>
            <input class="settings-input" type="password" name="confirm_password" minlength="8" required autocomplete="new-password" />
          </label>

          <button class="btn btn-primary w-full mt-2" type="submit">Update Password</button>
        </form>
      </article>

      <article class="settings-card rounded-2xl p-6 lg:col-span-2">
        <h2 class="text-lg font-semibold">Repository</h2>
        <p class="text-sm text-slate-500">Source URL used by install and update scripts.</p>

        {% if repo_success %}
          <div class="alert alert-success text-sm mt-3">
            <span>{{ repo_success }}</span>
          </div>
        {% endif %}

        {% if repo_error %}
          <div class="alert alert-error text-sm mt-3">
            <span>{{ repo_error }}</span>
          </div>
        {% endif %}

        <form method="post" action="{{ ui_prefix }}/settings/repo" class="space-y-3 mt-4">
          <label class="block">
            <span class="settings-label">GitHub Repository URL</span>
            <input
              class="settings-input mono"
              type="url"
              name="github_repo_url"
              required
              value="{{ github_repo_url }}"
              placeholder="https://github.com/Dinkum/uptime-mesh"
            />
            <p class="settings-help">Default is https://github.com/Dinkum/uptime-mesh</p>
          </label>
          <button class="btn btn-primary" type="submit">Update Repository URL</button>
        </form>
      </article>
    </section>
  {% endif %}
{% endblock %}
