{% extends "layout.html" %}

{% block content %}
  <style>
    .settings-card {
      border: 1px solid rgba(148, 163, 184, 0.24);
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.82));
      box-shadow: 0 22px 48px rgba(2, 6, 23, 0.55);
      backdrop-filter: blur(7px);
    }
    .settings-label {
      display: block;
      margin-bottom: 0.35rem;
      font-size: 0.84rem;
      color: #cbd5e1;
      font-weight: 600;
    }
    .settings-input {
      width: 100%;
      min-width: 0;
      border-radius: 0.75rem;
      border: 1px solid rgba(100, 116, 139, 0.75);
      background: rgba(2, 6, 23, 0.75);
      color: #f8fafc;
      padding: 0.72rem 0.9rem;
      line-height: 1.35;
    }
    .settings-input::placeholder {
      color: #94a3b8;
    }
    .settings-input:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.95);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
    }
    .settings-help {
      color: #94a3b8;
      font-size: 0.8rem;
      margin-top: 0.35rem;
    }
  </style>

  <div class="flex flex-wrap gap-3 mb-6">
    <a class="btn btn-sm {% if settings_section == 'auth' %}btn-primary{% else %}btn-outline{% endif %}" href="{{ ui_prefix }}/settings?section=auth">Auth & Preferences</a>
    <a class="btn btn-sm {% if settings_section == 'support' %}btn-primary{% else %}btn-outline{% endif %}" href="{{ ui_prefix }}/settings?section=support">Support & Snapshots</a>
  </div>

  {% if settings_section == "support" %}
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <article class="settings-card rounded-2xl p-6">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">etcd Snapshots</h2>
            <p class="text-sm text-slate-500">Run snapshots now and track restore readiness.</p>
          </div>
          <button class="btn btn-sm btn-outline" id="snapshot-btn">Request Snapshot</button>
        </div>
        <div class="mt-4 space-y-2 text-sm" id="snapshot-list">
          {% for snapshot in snapshots %}
            <div class="rounded-xl border border-slate-700/40 p-3">
              <div class="flex justify-between items-center gap-3">
                <div class="flex flex-col min-w-0">
                  <span class="mono truncate">{{ snapshot.id }}</span>
                  {% if snapshot.location %}
                    <span class="text-xs text-slate-500 truncate">{{ snapshot.location }}</span>
                  {% endif %}
                </div>
                <div class="flex items-center gap-2 shrink-0">
                  <span class="badge badge-outline">{{ snapshot.status }}</span>
                  {% if snapshot.status == "completed" %}
                    <button class="btn btn-xs btn-outline snapshot-restore-btn" data-snapshot-id="{{ snapshot.id }}">Restore</button>
                    {% if snapshot.location %}
                      <a class="btn btn-xs btn-outline" href="/etcd/snapshots/{{ snapshot.id }}/download">Download</a>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
              {% if snapshot.error %}
                <p class="text-xs text-rose-300 break-all mt-2">{{ snapshot.error }}</p>
              {% endif %}
            </div>
          {% else %}
            <p class="text-slate-400">No snapshots yet.</p>
          {% endfor %}
        </div>
      </article>

      <article class="settings-card rounded-2xl p-6">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">Support Bundles</h2>
            <p class="text-sm text-slate-500">Collect redacted diagnostics for troubleshooting.</p>
          </div>
          <button class="btn btn-sm btn-outline" id="bundle-btn">Request Bundle</button>
        </div>
        <div class="mt-4 space-y-2 text-sm" id="bundle-list">
          {% for bundle in bundles %}
            <div class="rounded-xl border border-slate-700/40 p-3">
              <div class="flex justify-between items-center gap-3">
                <span class="mono truncate">{{ bundle.id }}</span>
                <div class="flex items-center gap-2 shrink-0">
                  <span class="badge badge-outline">{{ bundle.status }}</span>
                  {% if bundle.status == "completed" and bundle.path %}
                    <a class="btn btn-xs btn-outline" href="/support-bundles/{{ bundle.id }}/download">Download</a>
                  {% endif %}
                </div>
              </div>
              {% if bundle.error %}
                <p class="text-xs text-rose-300 break-all mt-2">{{ bundle.error }}</p>
              {% endif %}
            </div>
          {% else %}
            <p class="text-slate-400">No bundles yet.</p>
          {% endfor %}
        </div>
      </article>
    </section>

    <script>
      const snapshotBtn = document.getElementById("snapshot-btn");
      const bundleBtn = document.getElementById("bundle-btn");

      function addRow(containerId, id, status, extras) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const row = document.createElement("div");
        row.className = "rounded-xl border border-slate-700/40 p-3";

        if (containerId === "snapshot-list") {
          const restoreButton = status === "completed"
            ? `<button class="btn btn-xs btn-outline snapshot-restore-btn" data-snapshot-id="${id}">Restore</button>`
            : "";
          const download = extras && extras.download
            ? `<a class="btn btn-xs btn-outline" href="${extras.download}">Download</a>`
            : "";
          const error = extras && extras.error
            ? `<p class="text-xs text-rose-300 break-all mt-2">${extras.error}</p>`
            : "";
          row.innerHTML = `
            <div class="flex justify-between items-center gap-3">
              <div class="flex flex-col min-w-0">
                <span class="mono truncate">${id}</span>
              </div>
              <div class="flex items-center gap-2 shrink-0">
                <span class="badge badge-outline">${status}</span>
                ${restoreButton}
                ${download}
              </div>
            </div>
            ${error}
          `;
        } else {
          const download = extras && extras.download
            ? `<a class="btn btn-xs btn-outline" href="${extras.download}">Download</a>`
            : "";
          const error = extras && extras.error
            ? `<p class="text-xs text-rose-300 break-all mt-2">${extras.error}</p>`
            : "";
          row.innerHTML = `
            <div class="flex justify-between items-center gap-3">
              <span class="mono truncate">${id}</span>
              <div class="flex items-center gap-2 shrink-0">
                <span class="badge badge-outline">${status}</span>
                ${download}
              </div>
            </div>
            ${error}
          `;
        }

        container.prepend(row);
      }

      async function restoreSnapshot(snapshotId) {
        const response = await fetch(`/etcd/snapshots/${snapshotId}/restore`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        if (response.ok) {
          const data = await response.json();
          const download = data.location ? `/etcd/snapshots/${data.id}/download` : "";
          addRow("snapshot-list", data.id, data.status, { download, error: data.error || "" });
        }
      }

      if (snapshotBtn) {
        snapshotBtn.addEventListener("click", async () => {
          const id = crypto.randomUUID();
          const response = await fetch("/etcd/snapshots", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id })
          });
          if (response.ok) {
            const data = await response.json();
            const download = data.location ? `/etcd/snapshots/${data.id}/download` : "";
            addRow("snapshot-list", data.id, data.status, { download, error: data.error || "" });
          }
        });
      }

      if (bundleBtn) {
        bundleBtn.addEventListener("click", async () => {
          const id = crypto.randomUUID();
          const response = await fetch("/support-bundles", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id })
          });
          if (response.ok) {
            const data = await response.json();
            const download = data.path ? `/support-bundles/${data.id}/download` : "";
            addRow("bundle-list", data.id, data.status, { download, error: data.error || "" });
          }
        });
      }

      document.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        if (!target.classList.contains("snapshot-restore-btn")) {
          return;
        }
        const snapshotId = target.getAttribute("data-snapshot-id");
        if (!snapshotId) {
          return;
        }
        await restoreSnapshot(snapshotId);
      });
    </script>
  {% else %}
    <section class="grid gap-6 lg:grid-cols-2">
      <article class="settings-card rounded-2xl p-6">
        <h2 class="text-lg font-semibold">Authentication</h2>
        <p class="text-sm text-slate-500">Rotate the admin password used for UI access.</p>
        <div class="mt-3">
          <span class="text-xs uppercase tracking-widest text-slate-500">Current Username</span>
          <p class="mono text-sm mt-1">{{ username }}</p>
        </div>
      </article>

      <article class="settings-card rounded-2xl p-6">
        <h2 class="text-lg font-semibold">Change Password</h2>

        {% if password_success %}
          <div class="alert alert-success text-sm mt-3">
            <span>{{ password_success }}</span>
          </div>
        {% endif %}

        {% if password_error %}
          <div class="alert alert-error text-sm mt-3">
            <span>{{ password_error }}</span>
          </div>
        {% endif %}

        <form method="post" action="{{ ui_prefix }}/settings/password" class="space-y-3 mt-4">
          <label class="block">
            <span class="settings-label">Current Password</span>
            <input class="settings-input" type="password" name="current_password" required autocomplete="current-password" />
          </label>

          <label class="block">
            <span class="settings-label">New Password</span>
            <input class="settings-input" type="password" name="new_password" minlength="8" required autocomplete="new-password" />
            <p class="settings-help">Minimum 8 characters.</p>
          </label>

          <label class="block">
            <span class="settings-label">Confirm New Password</span>
            <input class="settings-input" type="password" name="confirm_password" minlength="8" required autocomplete="new-password" />
          </label>

          <button class="btn btn-primary w-full mt-2" type="submit">Update Password</button>
        </form>
      </article>

      <article class="settings-card rounded-2xl p-6 lg:col-span-2">
        <h2 class="text-lg font-semibold">Repository</h2>
        <p class="text-sm text-slate-500">Source URL used by install and update scripts.</p>

        {% if repo_success %}
          <div class="alert alert-success text-sm mt-3">
            <span>{{ repo_success }}</span>
          </div>
        {% endif %}

        {% if repo_error %}
          <div class="alert alert-error text-sm mt-3">
            <span>{{ repo_error }}</span>
          </div>
        {% endif %}

        <form method="post" action="{{ ui_prefix }}/settings/repo" class="space-y-3 mt-4">
          <label class="block">
            <span class="settings-label">GitHub Repository URL</span>
            <input
              class="settings-input mono"
              type="url"
              name="github_repo_url"
              required
              value="{{ github_repo_url }}"
              placeholder="https://github.com/Dinkum/uptime-mesh"
            />
            <p class="settings-help">Default is https://github.com/Dinkum/uptime-mesh</p>
          </label>
          <button class="btn btn-primary" type="submit">Update Repository URL</button>
        </form>
      </article>
    </section>
  {% endif %}
{% endblock %}
