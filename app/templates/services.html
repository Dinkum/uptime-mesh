{% extends "layout.html" %}

{% block content %}
  <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Services</p>
      <p class="text-2xl font-semibold">{{ services|length }}</p>
    </div>
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Stalled Rollouts</p>
      <p class="text-2xl font-semibold text-amber-200">{{ stalled_rollouts }}</p>
    </div>
    <div class="mesh-card rounded-2xl p-5">
      <p class="text-sm text-slate-500">Error Rollouts</p>
      <p class="text-2xl font-semibold text-rose-300">{{ error_rollouts }}</p>
    </div>
  </section>

  <div class="mesh-card bg-white rounded-2xl p-6">
    <h2 class="text-lg font-semibold">Service Rollout Status</h2>
    <div class="overflow-x-auto mt-4">
      <table class="table w-full align-middle">
        <thead>
          <tr>
            <th>Service</th>
            <th>Generation</th>
            <th>Progress</th>
            <th>Replica State</th>
            <th>Rollout</th>
            <th>Requested</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rollout_rows %}
            <tr>
              <td>
                <p class="font-semibold">{{ row.service_name }}</p>
                <p class="mono text-[11px] text-slate-500">{{ row.service_id }}</p>
              </td>
              <td class="mono">{{ row.generation }}</td>
              <td>
                <p class="mono text-xs">{{ row.progress_pct }}%</p>
                <progress class="progress progress-info w-40" value="{{ row.progress_pct }}" max="100"></progress>
              </td>
              <td class="mono text-xs">
                up {{ row.up_to_date }} / {{ row.total }}
                <p class="text-[11px] text-slate-500 mt-1">outdated {{ row.outdated }} · pending {{ row.pending }} · active {{ row.in_progress }} · failed {{ row.failed }}</p>
              </td>
              <td>
                {% if row.state_key == "complete" %}
                  <span class="badge badge-success badge-outline">{{ row.state_text }}</span>
                {% elif row.state_key == "rolling" %}
                  <span class="badge badge-info badge-outline">{{ row.state_text }}</span>
                {% elif row.state_key in ["stalled", "outdated"] %}
                  <span class="badge badge-warning badge-outline">{{ row.state_text }}</span>
                {% elif row.state_key == "error" %}
                  <span class="badge badge-error badge-outline">{{ row.state_text }}</span>
                {% else %}
                  <span class="badge badge-outline">{{ row.state_text }}</span>
                {% endif %}
              </td>
              <td class="mono text-xs">{{ row.rollout_requested_age }}</td>
              <td>
                <div class="flex gap-2">
                  <button class="btn btn-xs btn-outline" onclick="serviceAction('{{ row.service_id }}', 'apply-pinned')">Apply</button>
                  <button class="btn btn-xs btn-outline" onclick="serviceAction('{{ row.service_id }}', 'rollout')">Rollout</button>
                  <button class="btn btn-xs btn-outline" onclick="serviceAction('{{ row.service_id }}', 'rollback')">Rollback</button>
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="7" class="text-center text-slate-400">No services defined yet.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    async function serviceAction(serviceId, action) {
      const response = await fetch(`/services/${serviceId}/${action}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: "{}"
      });
      if (response.ok) {
        window.location.reload();
      }
    }
  </script>
{% endblock %}
