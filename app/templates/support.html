{% extends "layout.html" %}

{% block content %}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="mesh-card bg-white rounded-2xl p-6">
      <h2 class="text-lg font-semibold">etcd Snapshots</h2>
      <p class="text-sm text-slate-500">Run snapshots now and track execution status.</p>
      <button class="btn btn-sm btn-outline mt-4" id="snapshot-btn">Request snapshot</button>
      <div class="mt-4 space-y-2 text-sm" id="snapshot-list">
        {% for snapshot in snapshots %}
          <div class="flex justify-between items-center gap-3">
            <div class="flex flex-col">
              <span class="mono">{{ snapshot.id }}</span>
              {% if snapshot.location %}
                <span class="text-xs text-slate-400">{{ snapshot.location }}</span>
              {% endif %}
            </div>
            <div class="flex items-center gap-2">
              <span>{{ snapshot.status }}</span>
              {% if snapshot.status == "completed" %}
                <button class="btn btn-xs btn-outline snapshot-restore-btn" data-snapshot-id="{{ snapshot.id }}">Restore</button>
                {% if snapshot.location %}
                  <a class="btn btn-xs btn-outline" href="/etcd/snapshots/{{ snapshot.id }}/download">Download</a>
                {% endif %}
              {% endif %}
            </div>
          </div>
          {% if snapshot.error %}
            <p class="text-xs text-red-600 break-all">{{ snapshot.error }}</p>
          {% endif %}
        {% else %}
          <p class="text-slate-400">No snapshots yet.</p>
        {% endfor %}
      </div>
    </div>

    <div class="mesh-card bg-white rounded-2xl p-6">
      <h2 class="text-lg font-semibold">Support Bundles</h2>
      <p class="text-sm text-slate-500">Collect logs and configs for diagnostics.</p>
      <button class="btn btn-sm btn-outline mt-4" id="bundle-btn">Request bundle</button>
      <div class="mt-4 space-y-2 text-sm" id="bundle-list">
        {% for bundle in bundles %}
          <div class="flex justify-between items-center gap-3">
            <span class="mono">{{ bundle.id }}</span>
            <div class="flex items-center gap-2">
              <span>{{ bundle.status }}</span>
              {% if bundle.status == "completed" and bundle.path %}
                <a class="btn btn-xs btn-outline" href="/support-bundles/{{ bundle.id }}/download">Download</a>
              {% endif %}
            </div>
          </div>
          {% if bundle.error %}
            <p class="text-xs text-red-600 break-all">{{ bundle.error }}</p>
          {% endif %}
        {% else %}
          <p class="text-slate-400">No bundles yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <script>
    const snapshotBtn = document.getElementById("snapshot-btn");
    const bundleBtn = document.getElementById("bundle-btn");

    function addRow(containerId, id, status, extras) {
      const container = document.getElementById(containerId);
      const row = document.createElement("div");
      row.className = "flex justify-between items-center gap-3";
      if (containerId === "snapshot-list") {
        const restoreButton = status === "completed"
          ? `<button class="btn btn-xs btn-outline snapshot-restore-btn" data-snapshot-id="${id}">Restore</button>`
          : "";
        const download = extras && extras.download
          ? `<a class="btn btn-xs btn-outline" href="${extras.download}">Download</a>`
          : "";
        const error = extras && extras.error
          ? `<p class="text-xs text-red-600 break-all">${extras.error}</p>`
          : "";
        row.innerHTML = `<div class="flex flex-col"><span class="mono">${id}</span>${error}</div><div class="flex items-center gap-2"><span>${status}</span>${restoreButton}${download}</div>`;
      } else {
        const download = extras && extras.download
          ? `<a class="btn btn-xs btn-outline" href="${extras.download}">Download</a>`
          : "";
        const error = extras && extras.error
          ? `<p class="text-xs text-red-600 break-all">${extras.error}</p>`
          : "";
        row.innerHTML = `<div class="flex flex-col"><span class="mono">${id}</span>${error}</div><div class="flex items-center gap-2"><span>${status}</span>${download}</div>`;
      }
      container.prepend(row);
    }

    async function restoreSnapshot(snapshotId) {
      const response = await fetch(`/etcd/snapshots/${snapshotId}/restore`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      });
      if (response.ok) {
        const data = await response.json();
        const download = data.location ? `/etcd/snapshots/${data.id}/download` : "";
        addRow("snapshot-list", data.id, data.status, { download, error: data.error || "" });
      }
    }

    snapshotBtn.addEventListener("click", async () => {
      const id = crypto.randomUUID();
      const response = await fetch("/etcd/snapshots", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      if (response.ok) {
        const data = await response.json();
        const download = data.location ? `/etcd/snapshots/${data.id}/download` : "";
        addRow("snapshot-list", data.id, data.status, { download, error: data.error || "" });
      }
    });

    bundleBtn.addEventListener("click", async () => {
      const id = crypto.randomUUID();
      const response = await fetch("/support-bundles", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      if (response.ok) {
        const data = await response.json();
        const download = data.path ? `/support-bundles/${data.id}/download` : "";
        addRow("bundle-list", data.id, data.status, { download, error: data.error || "" });
      }
    });

    document.addEventListener("click", async (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }
      if (!target.classList.contains("snapshot-restore-btn")) {
        return;
      }
      const snapshotId = target.getAttribute("data-snapshot-id");
      if (!snapshotId) {
        return;
      }
      await restoreSnapshot(snapshotId);
    });
  </script>
{% endblock %}
