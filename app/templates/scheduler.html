{% extends "layout.html" %}

{% block content %}
  <div class="mesh-card bg-white rounded-2xl p-6">
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div>
        <h2 class="text-lg font-semibold">Scheduler Plan</h2>
        <p class="text-sm text-slate-500">Dry-run view of desired placement and update queue actions.</p>
      </div>
      <div class="flex gap-2">
        <button class="btn btn-sm btn-outline" onclick="schedulerPlanAll()">Refresh Plan</button>
        <button class="btn btn-sm btn-primary" onclick="schedulerReconcileAll()">Apply Reconcile</button>
      </div>
    </div>

    <div id="scheduler-summary" class="mt-4 text-sm text-slate-600">
      Services planned: <span class="mono">{{ plan.results | length }}</span>
    </div>

    <div id="scheduler-results" class="mt-6 space-y-4">
      {% for result in plan.results %}
        <div class="rounded-xl border border-slate-100 p-4">
          <div class="flex items-center justify-between">
            <p class="font-semibold mono">{{ result.service_id }}</p>
            <p class="text-xs text-slate-500">desired: {{ result.desired_replicas }} · actual: {{ result.actual_replicas }}</p>
          </div>
          <p class="text-xs text-slate-500 mt-1">eligible nodes: {{ result.eligible_nodes }} · dry-run: {{ result.dry_run }}</p>

          <div class="mt-3">
            <p class="text-xs uppercase tracking-wide text-slate-400">Actions</p>
            {% if result.actions %}
              <div class="mt-2 space-y-1">
                {% for action in result.actions %}
                  <p class="text-sm mono">{{ action.action }}{% if action.replica_id %} {{ action.replica_id }}{% endif %}{% if action.source_node_id %} from {{ action.source_node_id }}{% endif %}{% if action.target_node_id %} to {{ action.target_node_id }}{% endif %}</p>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-sm text-slate-400 mt-2">No actions required.</p>
            {% endif %}
          </div>

          <div class="mt-3">
            <p class="text-xs uppercase tracking-wide text-slate-400">Warnings</p>
            {% if result.warnings %}
              <div class="mt-2 space-y-1">
                {% for warning in result.warnings %}
                  <p class="text-sm text-amber-700">{{ warning }}</p>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-sm text-slate-400 mt-2">No warnings.</p>
            {% endif %}
          </div>

          <div class="mt-3">
            <button class="btn btn-xs btn-outline" onclick="reconcileService('{{ result.service_id }}')">Reconcile Service</button>
          </div>
        </div>
      {% else %}
        <p class="text-sm text-slate-400">No services found to schedule.</p>
      {% endfor %}
    </div>
  </div>

  <script>
    function escapeHtml(input) {
      return String(input)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function renderResults(plan) {
      const summary = document.getElementById("scheduler-summary");
      const resultsContainer = document.getElementById("scheduler-results");
      summary.innerHTML = `Services planned: <span class="mono">${plan.results.length}</span> · dry-run: <span class="mono">${plan.dry_run}</span>`;

      if (plan.results.length === 0) {
        resultsContainer.innerHTML = '<p class="text-sm text-slate-400">No services found to schedule.</p>';
        return;
      }

      resultsContainer.innerHTML = plan.results.map((result) => {
        const actionsHtml = (result.actions || []).length
          ? result.actions.map((action) => {
              const bits = [escapeHtml(action.action)];
              if (action.replica_id) bits.push(escapeHtml(action.replica_id));
              if (action.source_node_id) bits.push(`from ${escapeHtml(action.source_node_id)}`);
              if (action.target_node_id) bits.push(`to ${escapeHtml(action.target_node_id)}`);
              return `<p class="text-sm mono">${bits.join(" ")}</p>`;
            }).join("")
          : '<p class="text-sm text-slate-400 mt-2">No actions required.</p>';

        const warningsHtml = (result.warnings || []).length
          ? result.warnings.map((warning) => `<p class="text-sm text-amber-700">${escapeHtml(warning)}</p>`).join("")
          : '<p class="text-sm text-slate-400 mt-2">No warnings.</p>';

        return `
          <div class="rounded-xl border border-slate-100 p-4">
            <div class="flex items-center justify-between">
              <p class="font-semibold mono">${escapeHtml(result.service_id)}</p>
              <p class="text-xs text-slate-500">desired: ${result.desired_replicas} · actual: ${result.actual_replicas}</p>
            </div>
            <p class="text-xs text-slate-500 mt-1">eligible nodes: ${result.eligible_nodes} · dry-run: ${result.dry_run}</p>
            <div class="mt-3">
              <p class="text-xs uppercase tracking-wide text-slate-400">Actions</p>
              <div class="mt-2 space-y-1">${actionsHtml}</div>
            </div>
            <div class="mt-3">
              <p class="text-xs uppercase tracking-wide text-slate-400">Warnings</p>
              <div class="mt-2 space-y-1">${warningsHtml}</div>
            </div>
            <div class="mt-3">
              <button class="btn btn-xs btn-outline" onclick="reconcileService('${escapeHtml(result.service_id)}')">Reconcile Service</button>
            </div>
          </div>
        `;
      }).join("");
    }

    async function schedulerPlanAll() {
      const response = await fetch("/scheduler/plan/all");
      if (!response.ok) return;
      const data = await response.json();
      renderResults(data);
    }

    async function schedulerReconcileAll() {
      const response = await fetch("/scheduler/reconcile/all", { method: "POST" });
      if (!response.ok) return;
      const data = await response.json();
      renderResults(data);
    }

    async function reconcileService(serviceId) {
      const response = await fetch(`/scheduler/reconcile/services/${serviceId}`, { method: "POST" });
      if (!response.ok) return;
      await schedulerPlanAll();
    }
  </script>
{% endblock %}
